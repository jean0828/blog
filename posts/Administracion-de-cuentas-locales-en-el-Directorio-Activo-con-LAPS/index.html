<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="(ESP) Administracion de cuentas locales en el Directorio Activo con LAPS" /><meta property="og:locale" content="en" /><meta name="description" content="En ambientes empresariales es dificil realizar una administracion adecuada de las cuentas locales. Por ello, Microsoft tiene una herramienta gratuita llamada LAPS para administrar automaticamente las credenciales de los equipos que estan en el Directorio Activo. LAPS nos asegura que la contraseña de la cuenta local administradora es distinta en cada equipo. Pre-requisitos: SO cliente - Windows Server 2019, Windows Server 2016, Windows 10, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008, Windows Server 2003, Windows 7, Windows 8, Windows Vista, Windows 8.1 Active Directory – Windows Server 2003 SP1 o superior PowerShell 2.0 o superior, .Net Framework 4.0 o superior Tener un ambiente con Directorio Activo. En este caso el dominio se llama: lab.local Cuenta con permisos de Domain Admin Plantillas administrativas Para poder implementar LAPS se debe tener las plantillas administrativas que se pueden descargar aca. En especifico se necesitan la plantilla administrativa llamada AdmPwd Para este tutorial se creará un repositorio centralizado. Esto es recomendable en ambientes donde se tienen mas de un controldo de dominio. ir a la ruta \\lab.local\SYSVOL\lab.local\Policies y crear la carpeta PolicyDefinitions copiar el archivo AdmPwd.admx en la carpeta PolicyDefinitions copiart el archivo AdmPwd.adml en la carpeta PolicyDefinitions\en-US Preparar el ambiente para activar LAPS Identificar la OU en la que se activará LAPS En este tutorial, La OU para activar LAPS se llama servers en el que solo tenemos un equipo. Instalar extension de LAPS en los equipos que se requiere administrar la cuenta local de este link se descarga el archivo .msi e iniciamos el que se ajuste a nuestra arquitectura. Para la instalacion solamente necesitamos seguir con las instrucciones que traen por defecto NOTA: Esto tambien se puede desplegar por medio de una politica en el Directorio Activo Actualizar el Schema del Directorio Activo LAPS usa 2 atributois que por defecto no los tiene: ms-Mcs-AdmPwd : Save the administrator password in clear text ms-Mcs-AdmPwdExpirationTime : Save the timestamp of password expiration. Para extender el schema necesitamos instalar primero LAPS pero habilitando solamente la extension de GPO Posteriormente, se procede a abrir una consola PowerShell en modo administrador y actualizamos el schema de la siguiente mandera: 1 2 PS C:\Users\testing&gt; Import-module AdmPwd.PS PS C:\Users\testing&gt; Update-AdmPwdADSchema Cambiar permisos del objeto Computer During the password update process, the computer object itself should have permission to write values to ms-Mcs-AdmPwd and ms-Mcs-AdmPwdExpirationTime attributes. To do that we need to grant permissions to SELF built-in account. To do that, Run command: 1 PS C:\Users\testing&gt; Set-AdmPwdComputerSelfPermission -OrgUnit Servers Asignar permisos al grupo para acceso de password En este caso, se dara acceso para leer la contraseña al grupo llamado ITStaff. Para validar quien puede ver las contraseñas ejecutamos: 1 PS C:\Users\testing&gt; Find-AdmPwdExtendedRights -Identity servers encontramos que los domain admins son los unicos que por defecto pueden ver las credenciales Ahora, adicionamos los privilegios para que el grupo itstaff puedan ver la contraseña 1 PS C:\Users\testing&gt; Set-AdmPwdReadPasswordPermission -Identity &quot;Servers&quot; -AllowedPrincipals &quot;ITStaff&quot; Crear GPO para LAPS Abrir el Group Policy Management, crear una GPO para activar LAPS bajo la OU de Servers y dar en editar ir a la ruta: Computer Configuration Administrative Templates LAPS Testear LAPS para acelerar el proceso, se debe actualizar politicas en el servidor con: 1 C:\Users\testing&gt;gpupdate /force En el controlador de dominio con cuenta domain admin validar sus permisos: si, ensayamos las credenciales entramos con exito: Ahora, si intentamos visualizar el pass con otra cuenta que no tiene acceso (user en este caso) no se ve: y si lo hacemos con una cuenta del grupo ITStaff, comprobamos que el pass se ve:" /><meta property="og:description" content="En ambientes empresariales es dificil realizar una administracion adecuada de las cuentas locales. Por ello, Microsoft tiene una herramienta gratuita llamada LAPS para administrar automaticamente las credenciales de los equipos que estan en el Directorio Activo. LAPS nos asegura que la contraseña de la cuenta local administradora es distinta en cada equipo. Pre-requisitos: SO cliente - Windows Server 2019, Windows Server 2016, Windows 10, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008, Windows Server 2003, Windows 7, Windows 8, Windows Vista, Windows 8.1 Active Directory – Windows Server 2003 SP1 o superior PowerShell 2.0 o superior, .Net Framework 4.0 o superior Tener un ambiente con Directorio Activo. En este caso el dominio se llama: lab.local Cuenta con permisos de Domain Admin Plantillas administrativas Para poder implementar LAPS se debe tener las plantillas administrativas que se pueden descargar aca. En especifico se necesitan la plantilla administrativa llamada AdmPwd Para este tutorial se creará un repositorio centralizado. Esto es recomendable en ambientes donde se tienen mas de un controldo de dominio. ir a la ruta \\lab.local\SYSVOL\lab.local\Policies y crear la carpeta PolicyDefinitions copiar el archivo AdmPwd.admx en la carpeta PolicyDefinitions copiart el archivo AdmPwd.adml en la carpeta PolicyDefinitions\en-US Preparar el ambiente para activar LAPS Identificar la OU en la que se activará LAPS En este tutorial, La OU para activar LAPS se llama servers en el que solo tenemos un equipo. Instalar extension de LAPS en los equipos que se requiere administrar la cuenta local de este link se descarga el archivo .msi e iniciamos el que se ajuste a nuestra arquitectura. Para la instalacion solamente necesitamos seguir con las instrucciones que traen por defecto NOTA: Esto tambien se puede desplegar por medio de una politica en el Directorio Activo Actualizar el Schema del Directorio Activo LAPS usa 2 atributois que por defecto no los tiene: ms-Mcs-AdmPwd : Save the administrator password in clear text ms-Mcs-AdmPwdExpirationTime : Save the timestamp of password expiration. Para extender el schema necesitamos instalar primero LAPS pero habilitando solamente la extension de GPO Posteriormente, se procede a abrir una consola PowerShell en modo administrador y actualizamos el schema de la siguiente mandera: 1 2 PS C:\Users\testing&gt; Import-module AdmPwd.PS PS C:\Users\testing&gt; Update-AdmPwdADSchema Cambiar permisos del objeto Computer During the password update process, the computer object itself should have permission to write values to ms-Mcs-AdmPwd and ms-Mcs-AdmPwdExpirationTime attributes. To do that we need to grant permissions to SELF built-in account. To do that, Run command: 1 PS C:\Users\testing&gt; Set-AdmPwdComputerSelfPermission -OrgUnit Servers Asignar permisos al grupo para acceso de password En este caso, se dara acceso para leer la contraseña al grupo llamado ITStaff. Para validar quien puede ver las contraseñas ejecutamos: 1 PS C:\Users\testing&gt; Find-AdmPwdExtendedRights -Identity servers encontramos que los domain admins son los unicos que por defecto pueden ver las credenciales Ahora, adicionamos los privilegios para que el grupo itstaff puedan ver la contraseña 1 PS C:\Users\testing&gt; Set-AdmPwdReadPasswordPermission -Identity &quot;Servers&quot; -AllowedPrincipals &quot;ITStaff&quot; Crear GPO para LAPS Abrir el Group Policy Management, crear una GPO para activar LAPS bajo la OU de Servers y dar en editar ir a la ruta: Computer Configuration Administrative Templates LAPS Testear LAPS para acelerar el proceso, se debe actualizar politicas en el servidor con: 1 C:\Users\testing&gt;gpupdate /force En el controlador de dominio con cuenta domain admin validar sus permisos: si, ensayamos las credenciales entramos con exito: Ahora, si intentamos visualizar el pass con otra cuenta que no tiene acceso (user en este caso) no se ve: y si lo hacemos con una cuenta del grupo ITStaff, comprobamos que el pass se ve:" /><link rel="canonical" href="https://jean0828.github.io/blog/posts/Administracion-de-cuentas-locales-en-el-Directorio-Activo-con-LAPS/" /><meta property="og:url" content="https://jean0828.github.io/blog/posts/Administracion-de-cuentas-locales-en-el-Directorio-Activo-con-LAPS/" /><meta property="og:site_name" content="Unf0rG1v3n" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-27T03:20:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="(ESP) Administracion de cuentas locales en el Directorio Activo con LAPS" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-27T03:47:54+00:00","datePublished":"2022-05-27T03:20:00+00:00","description":"En ambientes empresariales es dificil realizar una administracion adecuada de las cuentas locales. Por ello, Microsoft tiene una herramienta gratuita llamada LAPS para administrar automaticamente las credenciales de los equipos que estan en el Directorio Activo. LAPS nos asegura que la contraseña de la cuenta local administradora es distinta en cada equipo. Pre-requisitos: SO cliente - Windows Server 2019, Windows Server 2016, Windows 10, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008, Windows Server 2003, Windows 7, Windows 8, Windows Vista, Windows 8.1 Active Directory – Windows Server 2003 SP1 o superior PowerShell 2.0 o superior, .Net Framework 4.0 o superior Tener un ambiente con Directorio Activo. En este caso el dominio se llama: lab.local Cuenta con permisos de Domain Admin Plantillas administrativas Para poder implementar LAPS se debe tener las plantillas administrativas que se pueden descargar aca. En especifico se necesitan la plantilla administrativa llamada AdmPwd Para este tutorial se creará un repositorio centralizado. Esto es recomendable en ambientes donde se tienen mas de un controldo de dominio. ir a la ruta \\\\lab.local\\SYSVOL\\lab.local\\Policies y crear la carpeta PolicyDefinitions copiar el archivo AdmPwd.admx en la carpeta PolicyDefinitions copiart el archivo AdmPwd.adml en la carpeta PolicyDefinitions\\en-US Preparar el ambiente para activar LAPS Identificar la OU en la que se activará LAPS En este tutorial, La OU para activar LAPS se llama servers en el que solo tenemos un equipo. Instalar extension de LAPS en los equipos que se requiere administrar la cuenta local de este link se descarga el archivo .msi e iniciamos el que se ajuste a nuestra arquitectura. Para la instalacion solamente necesitamos seguir con las instrucciones que traen por defecto NOTA: Esto tambien se puede desplegar por medio de una politica en el Directorio Activo Actualizar el Schema del Directorio Activo LAPS usa 2 atributois que por defecto no los tiene: ms-Mcs-AdmPwd : Save the administrator password in clear text ms-Mcs-AdmPwdExpirationTime : Save the timestamp of password expiration. Para extender el schema necesitamos instalar primero LAPS pero habilitando solamente la extension de GPO Posteriormente, se procede a abrir una consola PowerShell en modo administrador y actualizamos el schema de la siguiente mandera: 1 2 PS C:\\Users\\testing&gt; Import-module AdmPwd.PS PS C:\\Users\\testing&gt; Update-AdmPwdADSchema Cambiar permisos del objeto Computer During the password update process, the computer object itself should have permission to write values to ms-Mcs-AdmPwd and ms-Mcs-AdmPwdExpirationTime attributes. To do that we need to grant permissions to SELF built-in account. To do that, Run command: 1 PS C:\\Users\\testing&gt; Set-AdmPwdComputerSelfPermission -OrgUnit Servers Asignar permisos al grupo para acceso de password En este caso, se dara acceso para leer la contraseña al grupo llamado ITStaff. Para validar quien puede ver las contraseñas ejecutamos: 1 PS C:\\Users\\testing&gt; Find-AdmPwdExtendedRights -Identity servers encontramos que los domain admins son los unicos que por defecto pueden ver las credenciales Ahora, adicionamos los privilegios para que el grupo itstaff puedan ver la contraseña 1 PS C:\\Users\\testing&gt; Set-AdmPwdReadPasswordPermission -Identity &quot;Servers&quot; -AllowedPrincipals &quot;ITStaff&quot; Crear GPO para LAPS Abrir el Group Policy Management, crear una GPO para activar LAPS bajo la OU de Servers y dar en editar ir a la ruta: Computer Configuration Administrative Templates LAPS Testear LAPS para acelerar el proceso, se debe actualizar politicas en el servidor con: 1 C:\\Users\\testing&gt;gpupdate /force En el controlador de dominio con cuenta domain admin validar sus permisos: si, ensayamos las credenciales entramos con exito: Ahora, si intentamos visualizar el pass con otra cuenta que no tiene acceso (user en este caso) no se ve: y si lo hacemos con una cuenta del grupo ITStaff, comprobamos que el pass se ve:","headline":"(ESP) Administracion de cuentas locales en el Directorio Activo con LAPS","mainEntityOfPage":{"@type":"WebPage","@id":"https://jean0828.github.io/blog/posts/Administracion-de-cuentas-locales-en-el-Directorio-Activo-con-LAPS/"},"url":"https://jean0828.github.io/blog/posts/Administracion-de-cuentas-locales-en-el-Directorio-Activo-con-LAPS/"}</script><title>(ESP) Administracion de cuentas locales en el Directorio Activo con LAPS | Unf0rG1v3n</title><link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/blog/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/blog/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Unf0rG1v3n"><meta name="application-name" content="Unf0rG1v3n"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/blog/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/blog/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/blog/" class="mx-auto"> </a></div><div class="site-title"> <a href="/blog/">Unf0rG1v3n</a></div><div class="site-subtitle font-italic">Security engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/blog/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/blog/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/blog/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/blog/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/blog/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/jean0828" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['jean.santamaria93','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/blog/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/blog/"> Home </a> </span> <span>(ESP) Administracion de cuentas locales en el Directorio Activo con LAPS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>(ESP) Administracion de cuentas locales en el Directorio Activo con LAPS</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1653621600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 27, 2022 </em> </span> <span> Updated <em class="" data-ts="1653623274" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 26, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/jean0828">Jean Pierre</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="594 words"> <em>3 min</em> read</span></div></div></div><div class="post-content"><p>En ambientes empresariales es dificil realizar una administracion adecuada de las cuentas locales. Por ello, Microsoft tiene una herramienta gratuita llamada LAPS para administrar automaticamente las credenciales de los equipos que estan en el Directorio Activo. LAPS nos asegura que la contraseña de la cuenta local administradora es distinta en cada equipo.</p><ul><li>Pre-requisitos:<ol><li>SO cliente - Windows Server 2019, Windows Server 2016, Windows 10, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008, Windows Server 2003, Windows 7, Windows 8, Windows Vista, Windows 8.1<li>Active Directory – Windows Server 2003 SP1 o superior<li>PowerShell 2.0 o superior, .Net Framework 4.0 o superior<li>Tener un ambiente con Directorio Activo. En este caso el dominio se llama: <code class="language-plaintext highlighter-rouge">lab.local</code><li>Cuenta con permisos de Domain Admin</ol></ul><h1 id="plantillas-administrativas">Plantillas administrativas</h1><p>Para poder implementar LAPS se debe tener las plantillas administrativas que se pueden descargar <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-client/group-policy/create-and-manage-central-store">aca</a>. En especifico se necesitan la plantilla administrativa llamada <code class="language-plaintext highlighter-rouge">AdmPwd</code></p><p>Para este tutorial se creará un repositorio centralizado. Esto es recomendable en ambientes donde se tienen mas de un controldo de dominio.</p><p>ir a la ruta <code class="language-plaintext highlighter-rouge">\\lab.local\SYSVOL\lab.local\Policies</code> y crear la carpeta <code class="language-plaintext highlighter-rouge">PolicyDefinitions</code></p><ul><li>copiar el archivo <em>AdmPwd.admx</em> en la carpeta <code class="language-plaintext highlighter-rouge">PolicyDefinitions</code><li>copiart el archivo <em>AdmPwd.adml</em> en la carpeta <code class="language-plaintext highlighter-rouge">PolicyDefinitions\en-US</code></ul><p><a href="https://i.imgur.com/b07fG2J.png" class="popup img-link "><img data-src="https://i.imgur.com/b07fG2J.png" alt="admpwd" class="lazyload" data-proofer-ignore></a> <a href="https://i.imgur.com/OeZAz35.png" class="popup img-link "><img data-src="https://i.imgur.com/OeZAz35.png" alt="admpwd2" class="lazyload" data-proofer-ignore></a></p><h1 id="preparar-el-ambiente-para-activar-laps">Preparar el ambiente para activar LAPS</h1><h2 id="identificar-la-ou-en-la-que-se-activará-laps"><span class="mr-2">Identificar la OU en la que se activará LAPS</span><a href="#identificar-la-ou-en-la-que-se-activará-laps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>En este tutorial, La OU para activar LAPS se llama servers en el que solo tenemos un equipo.</p><p><a href="https://i.imgur.com/Z2GDHLM.png" class="popup img-link "><img data-src="https://i.imgur.com/Z2GDHLM.png" alt="server" class="lazyload" data-proofer-ignore></a></p><h2 id="instalar-extension-de-laps-en-los-equipos-que-se-requiere-administrar-la-cuenta-local"><span class="mr-2">Instalar extension de LAPS en los equipos que se requiere administrar la cuenta local</span><a href="#instalar-extension-de-laps-en-los-equipos-que-se-requiere-administrar-la-cuenta-local" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>de este <a href="https://www.microsoft.com/en-us/download/details.aspx?id=46899">link</a> se descarga el archivo .msi e iniciamos el que se ajuste a nuestra arquitectura.</p><p>Para la instalacion solamente necesitamos seguir con las instrucciones que traen por defecto</p><p><a href="https://i.imgur.com/1oVeiDo.png" class="popup img-link "><img data-src="https://i.imgur.com/1oVeiDo.png" alt="inst" class="lazyload" data-proofer-ignore></a> <a href="https://i.imgur.com/vK8cvhG.png" class="popup img-link "><img data-src="https://i.imgur.com/vK8cvhG.png" alt="inst2" class="lazyload" data-proofer-ignore></a> <a href="https://i.imgur.com/X51gjhI.png" class="popup img-link "><img data-src="https://i.imgur.com/X51gjhI.png" alt="inst3" class="lazyload" data-proofer-ignore></a> <a href="https://i.imgur.com/aGtxGXX.png" class="popup img-link "><img data-src="https://i.imgur.com/aGtxGXX.png" alt="inst4" class="lazyload" data-proofer-ignore></a></p><p>NOTA: Esto tambien se puede desplegar por medio de una politica en el Directorio Activo</p><h2 id="actualizar-el-schema-del-directorio-activo"><span class="mr-2">Actualizar el Schema del Directorio Activo</span><a href="#actualizar-el-schema-del-directorio-activo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>LAPS usa 2 atributois que por defecto no los tiene:</p><ol><li><em>ms-Mcs-AdmPwd</em> : Save the administrator password in clear text<li><em>ms-Mcs-AdmPwdExpirationTime</em> : Save the timestamp of password expiration.</ol><p>Para extender el schema necesitamos instalar primero LAPS pero habilitando solamente la extension de GPO</p><p><a href="https://i.imgur.com/PRYH0OH.png" class="popup img-link "><img data-src="https://i.imgur.com/PRYH0OH.png" alt="inst-da" class="lazyload" data-proofer-ignore></a></p><p>Posteriormente, se procede a abrir una consola PowerShell en modo administrador y actualizamos el schema de la siguiente mandera:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>PS C:\Users\testing&gt; Import-module AdmPwd.PS
PS C:\Users\testing&gt; Update-AdmPwdADSchema
</pre></table></code></div></div><p><a href="https://i.imgur.com/dngLY3c.png" class="popup img-link "><img data-src="https://i.imgur.com/dngLY3c.png" alt="schema" class="lazyload" data-proofer-ignore></a></p><h2 id="cambiar-permisos-del-objeto-computer"><span class="mr-2">Cambiar permisos del objeto Computer</span><a href="#cambiar-permisos-del-objeto-computer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>During the password update process, the computer object itself should have permission to write values to ms-Mcs-AdmPwd and ms-Mcs-AdmPwdExpirationTime attributes. To do that we need to grant permissions to SELF built-in account.</p><p>To do that, Run command:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>PS C:\Users\testing&gt; Set-AdmPwdComputerSelfPermission -OrgUnit Servers
</pre></table></code></div></div><p><a href="https://i.imgur.com/gGV5BH7.png" class="popup img-link "><img data-src="https://i.imgur.com/gGV5BH7.png" alt="self" class="lazyload" data-proofer-ignore></a></p><h1 id="asignar-permisos-al-grupo-para-acceso-de-password">Asignar permisos al grupo para acceso de password</h1><p>En este caso, se dara acceso para leer la contraseña al grupo llamado <em>ITStaff</em>. Para validar quien puede ver las contraseñas ejecutamos:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>PS C:\Users\testing&gt;   Find-AdmPwdExtendedRights -Identity servers
</pre></table></code></div></div><p><a href="https://i.imgur.com/9Pit8K2.png" class="popup img-link "><img data-src="https://i.imgur.com/9Pit8K2.png" alt="seepass" class="lazyload" data-proofer-ignore></a></p><p>encontramos que los domain admins son los unicos que por defecto pueden ver las credenciales</p><p>Ahora, adicionamos los privilegios para que el grupo itstaff puedan ver la contraseña</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>PS C:\Users\testing&gt; Set-AdmPwdReadPasswordPermission -Identity "Servers" -AllowedPrincipals "ITStaff"
</pre></table></code></div></div><p><a href="https://i.imgur.com/KLSoaPX.png" class="popup img-link "><img data-src="https://i.imgur.com/KLSoaPX.png" alt="readpss" class="lazyload" data-proofer-ignore></a></p><h1 id="crear-gpo-para-laps">Crear GPO para LAPS</h1><p>Abrir el <em>Group Policy Management</em>, crear una GPO para activar LAPS bajo la OU de Servers y dar en editar</p><p><a href="https://i.imgur.com/OGMsIk1.png" class="popup img-link "><img data-src="https://i.imgur.com/OGMsIk1.png" alt="GPO" class="lazyload" data-proofer-ignore></a></p><div class="table-wrapper"><table><tbody><tr><td>ir a la ruta: Computer Configuration<td>Administrative Templates<td>LAPS</table></div><p><a href="https://i.imgur.com/sbEFLma.png" class="popup img-link "><img data-src="https://i.imgur.com/sbEFLma.png" alt="GPO2" class="lazyload" data-proofer-ignore></a> <a href="https://i.imgur.com/e4hxUpL.png" class="popup img-link "><img data-src="https://i.imgur.com/e4hxUpL.png" alt="GPO3" class="lazyload" data-proofer-ignore></a> <a href="https://i.imgur.com/6RpULRC.png" class="popup img-link "><img data-src="https://i.imgur.com/6RpULRC.png" alt="GPO4" class="lazyload" data-proofer-ignore></a> <a href="https://i.imgur.com/Vh1tZDD.png" class="popup img-link "><img data-src="https://i.imgur.com/Vh1tZDD.png" alt="GPO5" class="lazyload" data-proofer-ignore></a></p><h1 id="testear-laps">Testear LAPS</h1><p>para acelerar el proceso, se debe actualizar politicas en el servidor con:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>C:\Users\testing&gt;gpupdate /force
</pre></table></code></div></div><p><a href="https://i.imgur.com/M94PRQm.png" class="popup img-link "><img data-src="https://i.imgur.com/M94PRQm.png" alt="update" class="lazyload" data-proofer-ignore></a></p><p>En el controlador de dominio con cuenta domain admin validar sus permisos:</p><p><a href="https://i.imgur.com/HChSbsq.png" class="popup img-link "><img data-src="https://i.imgur.com/HChSbsq.png" alt="laps-da" class="lazyload" data-proofer-ignore></a></p><p>si, ensayamos las credenciales entramos con exito:</p><p><a href="https://i.imgur.com/bwyIiTY.png" class="popup img-link "><img data-src="https://i.imgur.com/bwyIiTY.png" alt="test" class="lazyload" data-proofer-ignore></a> <a href="https://i.imgur.com/UrpfEaS.png" class="popup img-link "><img data-src="https://i.imgur.com/UrpfEaS.png" alt="succ" class="lazyload" data-proofer-ignore></a></p><p>Ahora, si intentamos visualizar el pass con otra cuenta que no tiene acceso (user en este caso) no se ve:</p><p><a href="https://i.imgur.com/HpuFolA.png" class="popup img-link "><img data-src="https://i.imgur.com/HpuFolA.png" alt="no-pss" class="lazyload" data-proofer-ignore></a></p><p>y si lo hacemos con una cuenta del grupo ITStaff, comprobamos que el pass se ve:</p><p><a href="https://i.imgur.com/YzvuC9a.png" class="popup img-link "><img data-src="https://i.imgur.com/YzvuC9a.png" alt="pass" class="lazyload" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/blog/categories/security/'>security</a>, <a href='/blog/categories/active-directory/'>Active Directory</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/blog/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/blog/tags/active-directory/" class="post-tag no-text-decoration" >active directory</a> <a href="/blog/tags/laps/" class="post-tag no-text-decoration" >laps</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=(ESP)%20Administracion%20de%20cuentas%20locales%20en%20el%20Directorio%20Activo%20con%20LAPS%20-%20Unf0rG1v3n&url=https%3A%2F%2Fjean0828.github.io%2Fblog%2Fposts%2FAdministracion-de-cuentas-locales-en-el-Directorio-Activo-con-LAPS%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=(ESP)%20Administracion%20de%20cuentas%20locales%20en%20el%20Directorio%20Activo%20con%20LAPS%20-%20Unf0rG1v3n&u=https%3A%2F%2Fjean0828.github.io%2Fblog%2Fposts%2FAdministracion-de-cuentas-locales-en-el-Directorio-Activo-con-LAPS%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjean0828.github.io%2Fblog%2Fposts%2FAdministracion-de-cuentas-locales-en-el-Directorio-Activo-con-LAPS%2F&text=(ESP)%20Administracion%20de%20cuentas%20locales%20en%20el%20Directorio%20Activo%20con%20LAPS%20-%20Unf0rG1v3n" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/posts/LDAP-Monitoring-with-AMA-and-Microsoft-Sentinel/">LDAP Monitoring with AMA and Microsoft Sentinel</a><li><a href="/blog/posts/Deploying-a-Cloud-Environment-for-DevSecops/">Deploying a Cloud Environment for DevSecops</a><li><a href="/blog/posts/Analyzing-Packets-with-Wireshark-and-Python/">Analyzing Packets with Wireshark and Python</a><li><a href="/blog/posts/Administracion-de-cuentas-locales-en-el-Directorio-Activo-con-LAPS/">(ESP) Administracion de cuentas locales en el Directorio Activo con LAPS</a><li><a href="/blog/posts/Monitoring-Powershell-commands-with-Elastic-Stack/">Monitoring Powershell commands with Elastic Stack</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/blog/tags/sentinel/">sentinel</a> <a class="post-tag" href="/blog/tags/siem/">siem</a> <a class="post-tag" href="/blog/tags/active-directory/">active directory</a> <a class="post-tag" href="/blog/tags/windows/">windows</a> <a class="post-tag" href="/blog/tags/azure/">azure</a> <a class="post-tag" href="/blog/tags/devsecops/">devsecops</a> <a class="post-tag" href="/blog/tags/elastic/">elastic</a> <a class="post-tag" href="/blog/tags/google-cloud/">google cloud</a> <a class="post-tag" href="/blog/tags/jenkins/">jenkins</a> <a class="post-tag" href="/blog/tags/kubernetes/">kubernetes</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/posts/Linux-Authentication-with-Active-Directory/"><div class="card-body"> <em class="small" data-ts="1653351600" data-df="ll" > May 24, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux Authentication with Active Directory</h3><div class="text-muted small"><p> This is a tutorial to access with an Active Directory user in a linux server. For this tutorial we have the following devices: Active Directory Server: IP 10.0.0.4 Linux Server: IP 10.0.0.5 ...</p></div></div></a></div><div class="card"> <a href="/blog/posts/Monitoring-Powershell-commands-with-Elastic-Stack/"><div class="card-body"> <em class="small" data-ts="1653268800" data-df="ll" > May 23, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Monitoring Powershell commands with Elastic Stack</h3><div class="text-muted small"><p> In some cases it’s important to monitor all the powershell commands executed in a windows server because it can help us to alert possible attacks and lateral movements. For that reason, in this pos...</p></div></div></a></div><div class="card"> <a href="/blog/posts/LDAP-Monitoring-with-AMA-and-Microsoft-Sentinel/"><div class="card-body"> <em class="small" data-ts="1692795600" data-df="ll" > Aug 23, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>LDAP Monitoring with AMA and Microsoft Sentinel</h3><div class="text-muted small"><p> According to Microsoft. LDAP is “an application protocol for working with various directory services. Directory services, such as Active Directory, store user and account information, and security ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/posts/Linux-Authentication-with-Active-Directory/" class="btn btn-outline-primary" prompt="Older"><p>Linux Authentication with Active Directory</p></a> <a href="/blog/posts/Configuring-CIS-Compliance-Report-in-Nessus/" class="btn btn-outline-primary" prompt="Newer"><p>How to Configure CIS Compliance Report in Nessus</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/blog/tags/sentinel/">sentinel</a> <a class="post-tag" href="/blog/tags/siem/">siem</a> <a class="post-tag" href="/blog/tags/active-directory/">active directory</a> <a class="post-tag" href="/blog/tags/windows/">windows</a> <a class="post-tag" href="/blog/tags/azure/">azure</a> <a class="post-tag" href="/blog/tags/devsecops/">devsecops</a> <a class="post-tag" href="/blog/tags/elastic/">elastic</a> <a class="post-tag" href="/blog/tags/google-cloud/">google cloud</a> <a class="post-tag" href="/blog/tags/jenkins/">jenkins</a> <a class="post-tag" href="/blog/tags/kubernetes/">kubernetes</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/jean0828">Jean Pierre</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/blog/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/blog/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/blog/unregister.js"></script>
