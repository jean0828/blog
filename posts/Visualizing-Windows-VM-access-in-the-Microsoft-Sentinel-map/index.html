<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Visualizing Windows VM access in the Microsoft Sentinel map" /><meta property="og:locale" content="en" /><meta name="description" content="In the previous post we deployed Microsoft Sentinel with the connector to gather data from the Windows VM. Now, we can explore some workbooks to see pre-defined dashboards" /><meta property="og:description" content="In the previous post we deployed Microsoft Sentinel with the connector to gather data from the Windows VM. Now, we can explore some workbooks to see pre-defined dashboards" /><link rel="canonical" href="https://jean0828.github.io/blog/posts/Visualizing-Windows-VM-access-in-the-Microsoft-Sentinel-map/" /><meta property="og:url" content="https://jean0828.github.io/blog/posts/Visualizing-Windows-VM-access-in-the-Microsoft-Sentinel-map/" /><meta property="og:site_name" content="Unf0rG1v3n" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-12T03:20:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Visualizing Windows VM access in the Microsoft Sentinel map" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-12T03:38:06+00:00","datePublished":"2022-05-12T03:20:00+00:00","description":"In the previous post we deployed Microsoft Sentinel with the connector to gather data from the Windows VM. Now, we can explore some workbooks to see pre-defined dashboards","headline":"Visualizing Windows VM access in the Microsoft Sentinel map","mainEntityOfPage":{"@type":"WebPage","@id":"https://jean0828.github.io/blog/posts/Visualizing-Windows-VM-access-in-the-Microsoft-Sentinel-map/"},"url":"https://jean0828.github.io/blog/posts/Visualizing-Windows-VM-access-in-the-Microsoft-Sentinel-map/"}</script><title>Visualizing Windows VM access in the Microsoft Sentinel map | Unf0rG1v3n</title><link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/blog/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/blog/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Unf0rG1v3n"><meta name="application-name" content="Unf0rG1v3n"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/blog/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/blog/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/blog/" class="mx-auto"> </a></div><div class="site-title"> <a href="/blog/">Unf0rG1v3n</a></div><div class="site-subtitle font-italic">Security engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/blog/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/blog/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/blog/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/blog/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/blog/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/jean0828" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['jean.santamaria93','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/blog/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/blog/"> Home </a> </span> <span>Visualizing Windows VM access in the Microsoft Sentinel map</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Visualizing Windows VM access in the Microsoft Sentinel map</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1652325600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 12, 2022 </em> </span> <span> Updated <em class="" data-ts="1652326686" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 11, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/jean0828">Jean Pierre</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="899 words"> <em>4 min</em> read</span></div></div></div><div class="post-content"><p>In the <a href="https://jean0828.github.io/blog/posts/Deployment-Microsoft-Sentinel-(SIEM)">previous post</a> we deployed Microsoft Sentinel with the connector to gather data from the Windows VM. Now, we can explore some workbooks to see pre-defined dashboards</p><p><a href="https://i.imgur.com/N33kRjX.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/N33kRjX.png" alt="sentinel workbooks" title="sentinel workbooks" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>for example, we can use the workbook called “Windows Firewall”. There, it can be seen Windows Security events by account and IP.</p><p><a href="https://i.imgur.com/vPmRqAz.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/vPmRqAz.png" alt="IP connections" title="Ip connections" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>Furthermore, the workbook <em>Identity &amp; Access</em> shows details about authentications in the VM</p><p><a href="https://i.imgur.com/afE2AmY.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/afE2AmY.png" alt="identity workbook" title="identity workbook" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>Also, we can create queries to see authentication failed attempts. In the Logs sections of the Log Analytics Workspace, we can run:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>SecurityEvent
| where EventID == 4625 
</pre></table></code></div></div><p><a href="https://i.imgur.com/IkgTcEf.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/IkgTcEf.png" alt="security events" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>However, if we can go the overview tab in Microsoft Sentinel, it doesn’t show in the map the connections of the VM even when those connections are made by public IP adressess.</p><p><a href="https://i.imgur.com/BZBSFGo.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/BZBSFGo.png" alt="map" title="map" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>For that reason, we’re going to use a custom script to see conections to the VM in the map. This is an idea from <a href="https://youtu.be/RoZeVbbZ0o0">Josh Madakor</a>, thank you for sharing your knowledge.</p><h2 id="observing-auth-failed-log"><span class="mr-2">Observing Auth Failed log</span><a href="#observing-auth-failed-log" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>First of all, we need to ensure how to see the log when an authentication failed attempt in the Windows system. To do that, it’s needed to open <em>Event Viewer</em> → <em>Windows Logs</em> folder → <em>Security</em> channel</p><p><a href="https://i.imgur.com/9D7cmm5.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/9D7cmm5.png" alt="event viewer" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>In the security channel, the event 4625 shows what we want, and it shows important information like:</p><ul><li>account name<li>source workstation name<li>source IP address</ul><p><a href="https://i.imgur.com/GTpdlkd.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/GTpdlkd.png" alt="4625 event" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>Now, the idea is to take the source IP address with a script which creates a custom log and then it shows the country of the IP in the map with the help of ipgeolocation.io.</p><p><strong>NOTE</strong>: for better results in the SIEM, Windows Firewall is disabled. However, in a production envirtonment, you should keep turn it on.</p><p><a href="https://i.imgur.com/ewZ0Ekn.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/ewZ0Ekn.png" alt="Windows FW" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><h2 id="using-the-script"><span class="mr-2">Using the Script</span><a href="#using-the-script" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>to begin with, we have to download the script <a href="https://github.com/joshmadakor1/Sentinel-Lab/blob/main/Custom_Security_Log_Exporter.ps1">here</a>. Then, we must update the <em>API_KEY</em> varibale for using the script.</p><p>In order to get the API key, we have to create an account in <a href="https://ipgeolocation.io/">ipgeolocation.io</a>. Next, go to <em>Dashboard</em> and you see the API Key.</p><p><a href="https://i.imgur.com/ASOASFB.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/ASOASFB.png" alt="API key ipgeo" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>The script gathers all the information of failed authentications, it takes the IP address and creates a custom log.</p><p>Now, it’s time to run the script and see its results:</p><p><a href="https://i.imgur.com/tpN2FVC.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/tpN2FVC.png" alt="script-results" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>As you can see, there are real failed authentication attempts from Rusia.</p><h2 id="creating-custom-log-in-log-analytics-workspace-to-bring-the-log-from-the-script"><span class="mr-2">Creating custom log in Log Analytics Workspace to bring the log from the script</span><a href="#creating-custom-log-in-log-analytics-workspace-to-bring-the-log-from-the-script" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Firstly, in the azure portal, we go to the Log Analytics workspace → custom log → add custom log</p><p><a href="https://i.imgur.com/6EmhmJO.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/6EmhmJO.png" alt="creating custom log" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>Second, a copy of the log file created by the script must be downloaded in our local computer because it should be uploaded in the azure portal.</p><p>The log has the following format:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>latitude:47.91542,longitude:-120.60306,destinationhost:samplehost,username:fakeuser,sourcehost:24.16.97.222,state:Washington,country:United States,label:United States - 24.16.97.222,timestamp:2021-10-26 03:28:29
latitude:-22.90906,longitude:-47.06455,destinationhost:samplehost,username:lnwbaq,sourcehost:20.195.228.49,state:Sao Paulo,country:Brazil,label:Brazil - 20.195.228.49,timestamp:2021-10-26 05:46:20
latitude:52.37022,longitude:4.89517,destinationhost:samplehost,username:CSNYDER,sourcehost:89.248.165.74,state:North Holland,country:Netherlands,label:Netherlands - 89.248.165.74,timestamp:2021-10-26 06:12:56
latitude:40.71455,longitude:-74.00714,destinationhost:samplehost,username:ADMINISTRATOR,sourcehost:72.45.247.
latitude:55.88802,longitude:37.65136,destinationhost:vm-sw,username:Mel,sourcehost:94.232.44.12,state:Central Federal District, country:Russia,label:Russia - 94.232.44.12,timestamp:2022-05-10 00:16:26
latitude:55.88802,longitude:37.65136,destinationhost:vm-sw,username:db2admin,sourcehost:94.232.44.12,state:Central Federal District, country:Russia,label:Russia - 94.232.44.12,timestamp:2022-05-10 00:16:24
latitude:55.88802,longitude:37.65136,destinationhost:vm-sw,username:Administrator,sourcehost:94.232.44.12,state:Central Federal District, country:Russia,label:Russia - 94.232.44.12,timestamp:2022-05-10 00:16:22
</pre></table></code></div></div><p>Third, record delimiter → new line &amp; → Next</p><p><a href="https://i.imgur.com/W2xQyeU.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/W2xQyeU.png" alt="creating custom log II" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>Next, in the collection paths section selects:</p><ul><li>Type: Windows<li>Path (path of the log): <code class="language-plaintext highlighter-rouge">C:\ProgramData\failed_rdp.log</code></ul><p>After, in the details section, we put a name for the custom log: <code class="language-plaintext highlighter-rouge">FAILED_RDP_WITH_GEO</code> and then create.</p><p><a href="https://i.imgur.com/wYd7JjB.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/wYd7JjB.png" alt="custom log III" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>After aprox 20 minutes, we can query those logs in the Log analytics Workspace:</p><p><a href="https://i.imgur.com/Y7KOZDK.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/Y7KOZDK.png" alt="watching custom log" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>Nevertheless, those logs don’t have their fields created. Therefore, we have to parse the log with the following:</p><ul><li>select a log → right clic → <em>Extract field from …</em></ul><p><a href="https://i.imgur.com/srkaGnF.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/srkaGnF.png" alt="watching custom log" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>Notice the log has this format: <code class="language-plaintext highlighter-rouge">field1:value,field2:value,field3:value...</code></p><p>according to the log format, we have to select each value and save it in a field name. for example, with <em>latitude</em> field we have to save the extraction:</p><p><a href="https://i.imgur.com/8K53QFX.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/8K53QFX.png" alt="latitude" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>For the rest of the field, we have to do the same process:</p><ul><li>select a log → right clic → <em>Extract field from …</em> → select the value of the field → give field name → select field type → extract → save extraction.</ul><p>After some minutes, if you run again the query, you’ll see the new fields in the results sections for the new logs:</p><p><a href="https://i.imgur.com/SI9F5Iy.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/SI9F5Iy.png" alt="results-parsed" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p><strong>NOTE</strong>: in case that some of your field values in the search results is not highlighted, you have to modify that registry to correct its parsing.</p><p><a href="https://i.imgur.com/C2c9SPl.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/C2c9SPl.png" alt="modift-parsed" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>Besides, in the Custom logs → Custom fields, we can see the field names we created previuosly. In case that one of those fields is presenting a wrong parsing, we have to delete the custom field and extract it again.</p><h2 id="setup-map-in-sentinel-with-latitude-and-longitude-or-country"><span class="mr-2">Setup map in sentinel with latitude and longitude (or country)</span><a href="#setup-map-in-sentinel-with-latitude-and-longitude-or-country" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now, in the Microsoft Sentinel section, we visit Workbooks → Add Workbook. Then, in edition mode, removing all the widgets.</p><p><a href="https://i.imgur.com/KYh68gM.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/KYh68gM.png" alt="workbook" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>Afterward, add → add query</p><p><a href="https://i.imgur.com/82NFEqL.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/82NFEqL.png" alt="query" width="400" height="400" class="lazyload" data-proofer-ignore></a></p><p>paste this query:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>FAILED_RDP_WITH_GEO_CL | summarize event_count=count() by sourcehost_CF, latitude_CF, longitude_CF, country_CF, label_CF, destinationhost_CF
| where destinationhost_CF != "samplehost"
| where sourcehost_CF != ""
</pre></table></code></div></div><p>the query shows real failed authentication attempts by counts</p><p><a href="https://i.imgur.com/UjMkwpr.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/UjMkwpr.png" alt="query-results" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>In order to create the map, we choose <em>map</em> as visualization and the map settings will be shown to configure properly the map:</p><ul><li>locations info using: we can choose <em>latitude/longitude</em> or <em>country/region</em>. For this example, we’re using <em>country/region</em><li>Country/Region field: country_cf<li>size by: event_count<li>Metric value: event_count</ul><p>Finally, apply to update the map and <em>save and close</em></p><p><a href="https://i.imgur.com/Q1LxVM8.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/Q1LxVM8.png" alt="map-results" width="700" height="400" class="lazyload" data-proofer-ignore></a></p><p>Then, save the map, put a title: <em>Failed RDP map</em>, set the location, and save it.</p><p>At this moment, we have to wait some minutes or hours to see new failed authentications and see in the map.</p><p><a href="https://i.imgur.com/jEWQegV.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="https://i.imgur.com/jEWQegV.png" alt="final-map" width="700" height="400" class="lazyload" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/blog/categories/azure/'>Azure</a>, <a href='/blog/categories/security/'>security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/blog/tags/azure/" class="post-tag no-text-decoration" >azure</a> <a href="/blog/tags/sentinel/" class="post-tag no-text-decoration" >sentinel</a> <a href="/blog/tags/siem/" class="post-tag no-text-decoration" >siem</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Visualizing%20Windows%20VM%20access%20in%20the%20Microsoft%20Sentinel%20map%20-%20Unf0rG1v3n&url=https%3A%2F%2Fjean0828.github.io%2Fblog%2Fposts%2FVisualizing-Windows-VM-access-in-the-Microsoft-Sentinel-map%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Visualizing%20Windows%20VM%20access%20in%20the%20Microsoft%20Sentinel%20map%20-%20Unf0rG1v3n&u=https%3A%2F%2Fjean0828.github.io%2Fblog%2Fposts%2FVisualizing-Windows-VM-access-in-the-Microsoft-Sentinel-map%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjean0828.github.io%2Fblog%2Fposts%2FVisualizing-Windows-VM-access-in-the-Microsoft-Sentinel-map%2F&text=Visualizing%20Windows%20VM%20access%20in%20the%20Microsoft%20Sentinel%20map%20-%20Unf0rG1v3n" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/posts/LDAP-Monitoring-with-AMA-and-Microsoft-Sentinel/">LDAP Monitoring with AMA and Microsoft Sentinel</a><li><a href="/blog/posts/Deploying-a-Cloud-Environment-for-DevSecops/">Deploying a Cloud Environment for DevSecops</a><li><a href="/blog/posts/Analyzing-Packets-with-Wireshark-and-Python/">Analyzing Packets with Wireshark and Python</a><li><a href="/blog/posts/Administracion-de-cuentas-locales-en-el-Directorio-Activo-con-LAPS/">(ESP) Administracion de cuentas locales en el Directorio Activo con LAPS</a><li><a href="/blog/posts/Monitoring-Powershell-commands-with-Elastic-Stack/">Monitoring Powershell commands with Elastic Stack</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/blog/tags/sentinel/">sentinel</a> <a class="post-tag" href="/blog/tags/siem/">siem</a> <a class="post-tag" href="/blog/tags/active-directory/">active directory</a> <a class="post-tag" href="/blog/tags/windows/">windows</a> <a class="post-tag" href="/blog/tags/azure/">azure</a> <a class="post-tag" href="/blog/tags/devsecops/">devsecops</a> <a class="post-tag" href="/blog/tags/elastic/">elastic</a> <a class="post-tag" href="/blog/tags/google-cloud/">google cloud</a> <a class="post-tag" href="/blog/tags/jenkins/">jenkins</a> <a class="post-tag" href="/blog/tags/kubernetes/">kubernetes</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/posts/Deployment-Microsoft-Sentinel-(SIEM)/"><div class="card-body"> <em class="small" data-ts="1651108800" data-df="ll" > Apr 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deployment of Microsoft Sentinel (SIEM)</h3><div class="text-muted small"><p> Creating Azure Subscription We need to visit Azure web site. There, you should click in “Start Free” and continue with the steps. Now, we can sign in portal.azure.com. Creating VM in Azure...</p></div></div></a></div><div class="card"> <a href="/blog/posts/LDAP-Monitoring-with-AMA-and-Microsoft-Sentinel/"><div class="card-body"> <em class="small" data-ts="1692795600" data-df="ll" > Aug 23, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>LDAP Monitoring with AMA and Microsoft Sentinel</h3><div class="text-muted small"><p> According to Microsoft. LDAP is “an application protocol for working with various directory services. Directory services, such as Active Directory, store user and account information, and security ...</p></div></div></a></div><div class="card"> <a href="/blog/posts/Deploying-Wazuh-in-a-home-lab/"><div class="card-body"> <em class="small" data-ts="1662312600" data-df="ll" > Sep 4, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deploying Wazuh in a home lab</h3><div class="text-muted small"><p> In this post we’re going to deploy Wazuh. According to its website, Wazuh is is a free and open source security platform that unifies XDR and SIEM capabilities. It protects workloads across on-pre...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/posts/Deployment-Microsoft-Sentinel-(SIEM)/" class="btn btn-outline-primary" prompt="Older"><p>Deployment of Microsoft Sentinel (SIEM)</p></a> <a href="/blog/posts/Monitoring-Powershell-commands-with-Elastic-Stack/" class="btn btn-outline-primary" prompt="Newer"><p>Monitoring Powershell commands with Elastic Stack</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/blog/tags/sentinel/">sentinel</a> <a class="post-tag" href="/blog/tags/siem/">siem</a> <a class="post-tag" href="/blog/tags/active-directory/">active directory</a> <a class="post-tag" href="/blog/tags/windows/">windows</a> <a class="post-tag" href="/blog/tags/azure/">azure</a> <a class="post-tag" href="/blog/tags/devsecops/">devsecops</a> <a class="post-tag" href="/blog/tags/elastic/">elastic</a> <a class="post-tag" href="/blog/tags/google-cloud/">google cloud</a> <a class="post-tag" href="/blog/tags/jenkins/">jenkins</a> <a class="post-tag" href="/blog/tags/kubernetes/">kubernetes</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/jean0828">Jean Pierre</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/blog/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/blog/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/blog/unregister.js"></script>
